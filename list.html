<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>User Data Filtered by Date</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>

<body>
    <div class="container mt-5">
        <h4 class="text-center mb-4">User Submissions</h4>

        <!-- ðŸ“… Date Picker -->
        <div class="row mb-4 justify-content-center">
            <div class="col-md-4 col-sm-6">
                <input type="date" id="filterDate" class="form-control" />
            </div>
            <div class="col-md-2 col-sm-3">
                <button class="btn btn-primary w-100" onclick="fetchData()">Filter</button>
            </div>
        </div>

        <!-- ðŸ“‹ Table -->
        <div class="table-responsive">
            <table class="table table-bordered table-striped text-center align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Name</th>
                        <th>Retailer</th>
                        <th>Address</th>
                        <th>Latitude</th>
                        <th>Longitude</th>
                        <th>Submitted At</th>
                        <th>Map</th>
                    </tr>
                </thead>
                <tbody id="userTableBody"></tbody>
            </table>
        </div>

        <div id="status" class="mt-3 text-center text-muted"></div>
    </div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>

    <script>
        // âœ… Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyCuYcSe-tymWi2nENVq-fBgOzr2TBA4enc",
            authDomain: "live-location-2d40d.firebaseapp.com",
            projectId: "live-location-2d40d",
            databaseURL: "https://live-location-2d40d-default-rtdb.firebaseio.com",
            storageBucket: "live-location-2d40d.appspot.com",
            messagingSenderId: "923437376784",
            appId: "1:923437376784:web:f542d800e1536cdeccb195",
            measurementId: "G-80P6JMPTBD"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // âœ… Fetch data for today by default
        window.onload = function () {
            document.getElementById('filterDate').value = new Date().toISOString().split('T')[0];
            fetchData();
        };

        // âœ… Fetch data for selected date
        function fetchData() {
            const tbody = document.getElementById("userTableBody");
            const status = document.getElementById("status");
            const dateStr = document.getElementById('filterDate').value;

            tbody.innerHTML = '';
            status.textContent = 'Loading...';

            const selectedDate = new Date(dateStr);
            const start = new Date(selectedDate.setHours(0, 0, 0, 0));
            const end = new Date(selectedDate.setHours(23, 59, 59, 999));

            db.collection("users")
                .where("createdAt", ">=", start)
                .where("createdAt", "<=", end)
                .orderBy("createdAt", "desc")
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        status.textContent = "No records found for selected date.";
                        return;
                    }

                    let i = 1;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        const lat = data.location?.lat;
                        const lng = data.location?.lng;
                        const mapLink = lat && lng
                            ? `<a href="https://www.google.com/maps?q=${lat},${lng}" target="_blank" class="btn btn-sm btn-outline-primary">View</a>`
                            : "-";

                        const row = `
              <tr>
                <td>${i++}</td>
                <td>${data.name || ""}</td>
                <td>${data.retailer || ""}</td>
                <td>${data.address || ""}</td>
                <td>${lat?.toFixed(6) || "-"}</td>
                <td>${lng?.toFixed(6) || "-"}</td>
                <td>${data.createdAt?.toDate().toLocaleString() || "-"}</td>
                <td>${mapLink}</td>
              </tr>
            `;
                        tbody.insertAdjacentHTML("beforeend", row);
                    });

                    status.textContent = "";
                })
                .catch(error => {
                    console.error("Error fetching data:", error);
                    status.textContent = "Error fetching data.";
                });
        }
    </script>
</body>

</html>